version: 1.0

description: Executes the deleted machines check and then generates tickets in atlassian for the issues.

input:
  - cloud_account
  - all_projects
  - project_id
  - email
  - api_key
  - servicedesk_id
  - requesttype_id

vars:
  - stdout: null
  - stderr: null

output:
  - stdout: <% ctx().stdout %>
  - stderr: <% ctx().stderr %>

tasks:
  checks_deleted_machines:
    action: stackstorm_openstack.checks.deleted.machines
      cloud_account=<% ctx().cloud_account %>
      all_projects=<% ctx().all_projects %>
      project_id=<% ctx().project_id %>
    next:
      - when: <% succeeded() %>
        publish:
          - tickets_info: <% result().stdout %>
        do: create_tickets
  create_tickets:
    action: stackstorm_openstack.checks.create.tickets
      email=<% ctx().email %>
      api_key=<% ctx().api_key %>
      servicedesk_id=<% ctx().servicedesk_id %>
      requesttype_id=<% ctx().requesttype_id %>
      tickets_info=<% ctx().tickets_info %>
